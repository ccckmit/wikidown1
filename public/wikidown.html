<html>
<head>
<meta charset="utf-8" />
  <link rel="icon" href="favicon.ico">
  <link href="css/bootstrap.min.css" rel="stylesheet">
  <link href="main.css" rel="stylesheet">
</head>
<body onload="load()">
    <nav class="navbar navbar-inverse navbar-fixed-top">
      <div class="container">
        <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <div class="navbar-header">
          <a class="navbar-brand" href="#main" style="color:#cccc33"><span class="glyphicon glyphicon-home"></span></a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
          <form class="navbar-form navbar-right">
            <div class="form-group">
              <input id="filename" type="text" class="form-control" placeholder="filename" aria-describedby="basic-addon1" value="main">
			  <button class="btn btn-success" type="button" onclick="loadFile()">檢視</button>
              <button class="btn btn-success" type="button" onclick="editFile()">編輯</button>
              <button class="btn btn-success" type="button" onclick="saveFile()">儲存</button> 
			</div>
          </form>
        </div>
      </div>
    </nav>

    <div id="showPanel" class="tab-pane panel">
      <div id="htmlBox" class="container"></div>
    </div>
    <center>
      <div id="editPanel" class="tab-pane panel" style="width:90%; height:90%;">
        <br/>
        <textarea id="mdBox" class="form-control" style="width:100%; height:100%"></textarea>
      </div>
    </center>

<script>
DB = { 
  db:"md",
}

DB.save=function(name, doc) {
  $.ajax({
    type: "POST",
    url: "../db/"+DB.db+"/"+name,
    data: { obj: doc },
  })
  .done(function(data) {
    alert( "存檔完成!");
  })
  .fail(function() {
    alert( "存檔前請先登入！" );
  });
}

DB.load=function(name) {
  return $.ajax({
    type: "GET",
    url: "../db/"+DB.db+"/"+name,
    data: {}
  });
}

var filename, converter;
function load() {
  converter = new Showdown.converter({ extensions: ['table'] });
  if (window.location.hash === '')
    filename = $('#filename').val();
  else
    filename = window.location.hash.substring(1);
  showFile(filename);
}

function mdToHtml(md) {
  md  = md.replace(/\[\[([^\]]+?)\]\]\((.*?)\)/gi, '<a href="#$2" class="innerLink">$1</a>');
  md  = md.replace(/\[\[([^\]]+?)\]\]/gi, '<a href="#$1" class="innerLink">$1</a>');
  return converter.makeHtml(md);
}

function show(md) {
  $('#mdBox').val(md);
  var html = mdToHtml(md);
  $('#htmlBox').html(html);
  switchPanel('showPanel');
}

var mdNewFile = '# 標題：文件不存在\n\n您可以編輯後存檔！\n## 語法\n* [[內部連結]](innerLink)\n* [外部連結](link)';

function showFile(filename) {
  if (filename === null || filename === '')
    return;
  $('#filename').val(filename);
  window.location.hash = '#'+filename;
  DB.load(filename)
  .done(show)
  .fail(function() {
    show(mdNewFile);
  });
}

function switchPanel(name) {
  $('.panel').css( "display", "none");
  $('#'+name).css( "display", "block");
}

function loadFile() {
  filename = $('#filename').val();
  showFile(filename);
  switchPanel('showPanel');
}

function editFile() {
  switchPanel('editPanel');
}

function saveFile() {
  var md = $('#mdBox').val();
  DB.save(filename, md);
}

window.onhashchange = function () {
  filename = window.location.hash.substring(1);
  showFile(filename);
}

window.onbeforeunload = function(){}
</script>
    <script src="js/jquery.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/Showdown.min.js"></script>
    <script src="js/Showdown_table.min.js"></script>
</body>
</html>
